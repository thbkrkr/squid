<!doctype html>
<html>
<head>
<title>squid</title>
<link rel="icon" href="favicon.ico" type="image/gif">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.8/semantic.min.css">
</head><body>
<style>
/** begin:CSS **/

.main {
  padding-top: 1em;
}

.tpl {
  margin-top: 1em;
}

.output {
  font-size: 0.7em;
}

.status-OK,
.status-Up {
  color: #00BCD4;
}

.status-ERROR,
.status-Created,
.status-Exited,
.status-Restarting {
  color: #e91e63;
}

.status-Absent {
  color: #ff5722;
}

.status-Unknown {
  color: #999;
}

.json {
  margin: 0;
  font-size: 0.8em;
  line-height: 1.2em;
}

.ui.inverted.dimmer {
  background-color: rgba(255, 255, 255, 0.4);
}

.ellipsis {
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/** end:CSS **/
</style>
<!-- begin:HTML -->

<body>
<div class="main text ui container">
  <div class="ui top attached tabular menu">
    <a class="item pink action-nodes">nodes</a>
    <a class="item green action-status active">status</a>
    <a class="item teal action-up">up</a>
    <a class="item purple action-logs">history</a>
    <div class="right menu">
      <div class="item">
        <h2>squid</h2>
      </div>
    </div>
  </div>

  <div class="ui tpl nodes"></div>
  <div class="ui tpl up"></div>
  <div class="ui tpl status"></div>
  <div class="ui tpl logs"></div>

  <script type="text/html" id="tpl_loading">
    <div class="ui active inverted dimmer">
      <div class="ui large text loader">Loading</div>
    </div>
  </script>

  <script type="text/html" id="tpl_status">
    <h2>status</h2>
    <table class="ui celled very compact table">
      <tbody>
        <% for ( var c in obj ) { %>
        <tr class="toggle-control-def status-<%= obj[c].status %>">
          <td><%= obj[c].name %></td>
          <td><%= obj[c].fullStatus %></td>
          <td><%= obj[c].image %></td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </script>

  <script type="text/html" id="tpl_up">
    <h2>up</h2>
    <table class="ui celled very compact basic table">
      <tbody>
        <% for ( var cmd in obj ) { %>
        <tr>
          <td>
            <pre class="output"><% for ( var l in obj[cmd].result) { %><%= obj[cmd].result[l] + '\n'%><% } %></pre>
          </td>
        </tr>
        <tr class="status-<%= obj[cmd].cmd.status %>">
          <td>
            <%= obj[cmd].cmd.status %> - <%= obj[cmd].cmd.long_cmd %>
          </td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </script>

  <script type="text/html" id="tpl_nodes">
    <h2>nodes</h2>
    <% for ( var node in obj ) { %>
    <h3><%= node %></h3>
    <table class="ui celled very compact table">
      <tbody>
        <% for ( var s in obj[node] ) { %>
        <tr class="toggle-control-def status-<%= obj[node][s].status %>">
          <td><%= obj[node][s].name %></td>
          <td><%= obj[node][s].fullStatus %></td>
          <td class="ellipsis"><%= obj[node][s].image %></td>
        </tr>
        <% } %>
      </tbody>
    </table>
    <% } %>
  </script>

  <script type="text/html" id="tpl_logs">
    <h2>logs</h2>
    <table class="ui celled very compact basic table">
      <tbody>
        <% for ( var i in obj ) { %>
        <tr class="status-<%= obj[i].cmd.status %>">
          <td>
            <%= $fromNow(obj[i].cmd.timestamp) %>
          </td>
          <td>
            <%= obj[i].cmd.status %> - <%= obj[i].cmd.long_cmd %>
          </td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </script>

<!-- end:HTML -->
</div>
<script src="https://thbkrkr.github.io/s.js/dist/s.3.ad334a2.js"></script><script>
/** begin:JS */

  function $call(action) {
    if (action == null) {
      for (first in actions) break;
      action = first
    }

    obj = actions[action]

    // Unactive/active elements and reset template
    for ( var a in actions ) {
      if (a == action) {
        $('.action-'+a).addClass('active')
      } else {
        $('.tpl.'+a).html('')
        $('.action-'+a).removeClass('active')
      }
    }

    args = ""
    r = $param('r')
    if (r != null) args = "&r=" + r
    window.history.pushState(action, action, "?p=" + action + args)

    if (obj.loading) {
      $('.tpl.'+action).html($tpl('tpl_loading'))
    }

    $loadTpl(action)
  }

  //

actions = {
  nodes: {
    url: '/api/nodes/status'
  },
  status: {
    url: '/api/compose/status'
  },
  up: {
    url: '/api/compose/up',
    loading: true,
    onSuccess: function() {
      $loadTpl('status')
    }
  },
  logs: {
    url: '/api/executions',
    transform: function(data) {
      return data.reverse()
    }
  }
}

// -- main

function main() {
  $bind(actions)
  $call($param('p'))
}

main()

/** end:JS */
</script></body></html>